name: Build

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Install system dependencies
        run: sudo apt-get install -y binutils-mips-linux-gnu cpp-mips-linux-gnu ninja-build

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install Python dependencies
        run: uv sync

      - name: Cache pigment64
        id: cache-pigment64
        uses: actions/cache@v5
        with:
          path: ~/.cargo/bin/pigment64
          key: pigment64-${{ runner.os }}

      - name: Install pigment64
        if: steps.cache-pigment64.outputs.cache-hit != 'true'
        run: cargo install pigment64

      - name: Download ROM
        env:
          ROM_GDRIVE_ID: ${{ secrets.ROM_GDRIVE_ID }}
        run: uvx gdown "$ROM_GDRIVE_ID" -O pokemonsnap.z64

      - name: Cache splat
        uses: actions/cache@v5
        with:
          path: .splache
          key: splache-${{ hashFiles('splat.yaml', 'uv.lock') }}

      - name: Setup
        run: |
          uv run ./configure.py --setup
          uv run ./configure.py

      - name: Build
        run: bash -o pipefail -c 'ninja 2>&1 | tee build_log.txt'

      - name: Report Progress
        if: github.ref == 'refs/heads/main' && env.FROGRESS_KEY != ''
        env:
          FROGRESS_KEY: ${{ secrets.FROGRESS_KEY }}
        run: uv run python3 tools/progress.py --frogress "$FROGRESS_KEY"
